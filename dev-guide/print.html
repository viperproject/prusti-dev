<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Prusti dev guide</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="config/summary.html"><strong aria-hidden="true">2.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="config/providing.html"><strong aria-hidden="true">2.1.</strong> Providing Flags</a></li><li class="chapter-item expanded "><a href="config/flags.html"><strong aria-hidden="true">2.2.</strong> List of Configuration Flags</a></li></ol></li><li class="chapter-item expanded "><a href="pipeline/summary.html"><strong aria-hidden="true">3.</strong> Verification Pipeline</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pipeline/binary.html"><strong aria-hidden="true">3.1.</strong> Binary stage</a></li><li class="chapter-item expanded "><a href="pipeline/rust.html"><strong aria-hidden="true">3.2.</strong> Rust compilation stage</a></li><li class="chapter-item expanded "><a href="pipeline/prusti.html"><strong aria-hidden="true">3.3.</strong> Prusti processing stage</a></li><li class="chapter-item expanded "><a href="pipeline/viper.html"><strong aria-hidden="true">3.4.</strong> Viper verification stage</a></li><li class="chapter-item expanded "><a href="pipeline/report.html"><strong aria-hidden="true">3.5.</strong> Reporting stage</a></li></ol></li><li class="chapter-item expanded "><a href="macros.html"><strong aria-hidden="true">4.</strong> Macros</a></li><li class="chapter-item expanded "><a href="encoding/summary.html"><strong aria-hidden="true">5.</strong> Viper Encoding</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="encoding/types.html"><strong aria-hidden="true">5.1.</strong> Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="encoding/types-heap.html"><strong aria-hidden="true">5.1.1.</strong> Heap-based type encoding</a></li><li class="chapter-item expanded "><a href="encoding/types-snap.html"><strong aria-hidden="true">5.1.2.</strong> Snapshot-based type encoding</a></li></ol></li><li class="chapter-item expanded "><a href="encoding/pure.html"><strong aria-hidden="true">5.2.</strong> Pure function encoding</a></li><li class="chapter-item expanded "><a href="encoding/mangling.html"><strong aria-hidden="true">5.3.</strong> Name mangling</a></li></ol></li><li class="chapter-item expanded "><a href="layout.html"><strong aria-hidden="true">6.</strong> Repository Layout</a></li><li class="chapter-item expanded "><a href="development/summary.html"><strong aria-hidden="true">7.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="development/setup.html"><strong aria-hidden="true">7.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="development/build.html"><strong aria-hidden="true">7.2.</strong> Building</a></li><li class="chapter-item expanded "><a href="development/tests.html"><strong aria-hidden="true">7.3.</strong> Tests</a></li><li class="chapter-item expanded "><a href="development/ide.html"><strong aria-hidden="true">7.4.</strong> IDE integration</a></li><li class="chapter-item expanded "><a href="development/debug.html"><strong aria-hidden="true">7.5.</strong> Debugging</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prusti dev guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>This is the developer guide for <a href="https://github.com/viperproject/prusti-dev/">Prusti</a>, intended to make Prusti more approachable for new <em>contributors</em>. For installation instructions and a tutorial on using Prusti, see the <a href="https://viperproject.github.io/prusti-dev/user-guide">user guide</a>.</p>
<blockquote>
<p>Direct links to code are provided in boxes like this. Note that we sometimes link to specific lines in the linked files, which requires that the links refer to a specific commit in Prusti's history. When reading through the code using this guide, make sure to check if the code has since changed.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<ul>
<li><a href="config/providing.html">Providing Flags</a></li>
<li><a href="config/flags.html">List of Configuration Flags</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="providing-flags"><a class="header" href="#providing-flags">Providing Flags</a></h1>
<p>Flags can be set in one of four ways, in increasing order of priority:</p>
<ol>
<li>Provided individually as environment variables with the prefix <code>DEFAULT_PRUSTI_</code> (for example, <code>DEFAULT_PRUSTI_CACHE_PATH</code> for the <a href="config/flags.html#cache_path"><code>CACHE_PATH</code></a> flag).</li>
</ol>
<blockquote>
<p><strong>Note:</strong> One should only use this to change the default value of flags, such that this can be overridden by a config file</p>
</blockquote>
<ol start="2">
<li>
<p>Provided lowercase in a <code>Prusti.toml</code> file (<a href="https://docs.rs/config/latest/config/enum.FileFormat.html">allowed formats</a>, e.g. <code>check_overflows = true</code> for the <a href="config/flags.html#check_overflows"><code>CHECK_OVERFLOWS</code></a> flag). Prusti searches for a <code>Prusti.toml</code> depending on how it is run:<a name="flags-2"></a></p>
<ul>
<li>As <code>cargo prusti</code> (on an entire crate): in the <a href="https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-sets-for-crates"><code>CARGO_MANIFEST_DIR</code></a>, i.e. next to the crate's <code>Cargo.toml</code></li>
<li>As <code>prusti-rustc</code> (on a single Rust file): in the current working directory</li>
</ul>
</li>
<li>
<p>Provided individually as environment variables with the prefix <code>PRUSTI_</code> (for example, <code>PRUSTI_ASSERT_TIMEOUT</code> for the <a href="config/flags.html#assert_timeout"><code>ASSERT_TIMEOUT</code></a> flag).</p>
</li>
<li>
<p>Provided individually as command-line arguments to Prusti with the prefix <code>-P</code> (for example, <code>-Pprint_desugared_specs</code> for the <a href="config/flags.html#print_desugared_specs"><code>PRINT_DESUGARED_SPECS</code></a> flag).</p>
</li>
</ol>
<h2 id="multi-crate-cargo-prusti-projects"><a class="header" href="#multi-crate-cargo-prusti-projects">Multi-crate Cargo Prusti Projects</a></h2>
<p>Setting flags becomes slightly more complicated when Prusti is run on multiple crates as <code>cargo prusti</code>; e.g. which <code>Prusti.toml</code> file will be used. Though overriding priority as above remains the same, the three possible approaches to providing flags all behave differently, in particular depending on flag <a href="config/flags.html#list-of-configuration-flags">Category</a>.</p>
<h3 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h3>
<p>The environment persists throughout compilation, therefore all flags set through the <code>DEFAULT_PRUSTI_</code> or <code>PRUSTI_</code> will apply to all crates, and flags of both Category A and B. For example setting <code>PRUSTI_CHECK_OVERFLOWS=false</code> will disable overflow checks in all dependencies, even if they try to override this with a <code>Prusti.toml</code> file.</p>
<h3 id="prusti-config-file"><a class="header" href="#prusti-config-file">Prusti Config File</a></h3>
<p>A <code>Prusti.toml</code> is optionally loaded from the current working directory prior to compilation. This file is used to configure flags in Category B <em>only</em> and these flags apply to the entire compilation.</p>
<p>Then, as each individual crate is checked (from the roots of the dependency tree) a <code>Prusti.toml</code> is optionally loaded from the directory where the crate's corresponding <code>Cargo.toml</code> is located. This file is used to configure flags in Category A <em>only</em> — it would not make sense to set e.g. <a href="config/flags.html#no_verify_deps"><code>NO_VERIFY_DEPS</code></a> in a dependency since all of its dependencies have already been verified.</p>
<p>Therefore, when publishing a <code>lib</code> crate to git/crates.io one can configure Category A flags by including a <code>Prusti.toml</code> file next to their <code>Cargo.toml</code>.</p>
<blockquote>
<p><strong>Note:</strong> Currently cargo does not track <code>Prusti.toml</code> files as a <a href="https://doc.rust-lang.org/cargo/guide/build-cache.html#dep-info-files">dependency</a>, therefore if it's the only file that changed in a crate you may need to run <code>cargo clean -p &lt;crate&gt;</code> to force reverification</p>
</blockquote>
<p>The <code>Prusti.toml</code> used to load Category B flags at the start and the one used to load Category A flags at the end for the root crate will often be one and the same because <code>cargo prusti</code> is typically run from the root crate's directory. This can be changed by providing the <a href="https://doc.rust-lang.org/cargo/commands/cargo-check.html#manifest-options"><code>--manifest-path</code> flag</a>.</p>
<h3 id="commandline-arguments"><a class="header" href="#commandline-arguments">Commandline Arguments</a></h3>
<p>Prusti <code>-P</code> flags can be provided after a <code>--</code> (e.g. <code>cargo prusti -- -Pcargo_command=build</code>). Currently flags from Category B <em>only</em> are supported; providing a flag in Category A this way will be ignored.</p>
<p>Flags to cargo are provided in the <a href="https://doc.rust-lang.org/cargo/commands/cargo-check.html#options">regular way</a> (e.g. <code>cargo prusti --features foo</code>).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="list-of-configuration-flags"><a class="header" href="#list-of-configuration-flags">List of Configuration Flags</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Rust type</th><th>Default value</th><th>Multi-Crate Category</th></tr></thead><tbody>
<tr><td><a href="config/flags.html#allow_unreachable_unsupported_code"><code>ALLOW_UNREACHABLE_UNSUPPORTED_CODE</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#assert_timeout"><code>ASSERT_TIMEOUT</code></a></td><td><code>u64</code></td><td><code>10_000</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#be_rustc"><code>BE_RUSTC</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>B</td></tr>
<tr><td><a href="config/flags.html#boogie_path"><code>BOOGIE_PATH</code></a></td><td><code>Option&lt;String&gt;</code></td><td><code>env::var(&quot;BOOGIE_EXE&quot;)</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#cache_path"><code>CACHE_PATH</code></a></td><td><code>String</code></td><td><code>&quot;&quot;</code></td><td>A*</td></tr>
<tr><td><a href="config/flags.html#cargo_command"><code>CARGO_COMMAND</code></a></td><td><code>String</code></td><td><code>&quot;check&quot;</code></td><td>B</td></tr>
<tr><td><a href="config/flags.html#cargo_path"><code>CARGO_PATH</code></a></td><td><code>String</code></td><td><code>&quot;cargo&quot;</code></td><td>B</td></tr>
<tr><td><a href="config/flags.html#check_foldunfold_state"><code>CHECK_FOLDUNFOLD_STATE</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#check_overflows"><code>CHECK_OVERFLOWS</code></a></td><td><code>bool</code></td><td><code>true</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#check_panics"><code>CHECK_PANICS</code></a></td><td><code>bool</code></td><td><code>true</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#check_timeout"><code>CHECK_TIMEOUT</code></a></td><td><code>Option&lt;u32&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#counterexample"><code>COUNTEREXAMPLE</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#delete_basic_blocks"><code>DELETE_BASIC_BLOCKS</code></a></td><td><code>Vec&lt;String&gt;</code></td><td><code>vec![]</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#disable_name_mangling"><code>DISABLE_NAME_MANGLING</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#dump_borrowck_info"><code>DUMP_BORROWCK_INFO</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#dump_debug_info"><code>DUMP_DEBUG_INFO</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#dump_debug_info_during_fold"><code>DUMP_DEBUG_INFO_DURING_FOLD</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#dump_path_ctxt_in_debug_info"><code>DUMP_PATH_CTXT_IN_DEBUG_INFO</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#dump_reborrowing_dag_in_debug_info"><code>DUMP_REBORROWING_DAG_IN_DEBUG_INFO</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#dump_viper_program"><code>DUMP_VIPER_PROGRAM</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#enable_cache"><code>ENABLE_CACHE</code></a></td><td><code>bool</code></td><td><code>true</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#enable_purification_optimization"><code>ENABLE_PURIFICATION_OPTIMIZATION</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#enable_type_invariants"><code>ENABLE_TYPE_INVARIANTS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#enable_verify_only_basic_block_path"><code>ENABLE_VERIFY_ONLY_BASIC_BLOCK_PATH</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#encode_bitvectors"><code>ENCODE_BITVECTORS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#encode_unsigned_num_constraint"><code>ENCODE_UNSIGNED_NUM_CONSTRAINT</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#extra_jvm_args"><code>EXTRA_JVM_ARGS</code></a></td><td><code>Vec&lt;String&gt;</code></td><td><code>vec![]</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#extra_verifier_args"><code>EXTRA_VERIFIER_ARGS</code></a></td><td><code>Vec&lt;String&gt;</code></td><td><code>vec![]</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#foldunfold_state_filter"><code>FOLDUNFOLD_STATE_FILTER</code></a></td><td><code>String</code></td><td><code>&quot;&quot;</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#full_compilation"><code>FULL_COMPILATION</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A*</td></tr>
<tr><td><a href="config/flags.html#hide_uuids"><code>HIDE_UUIDS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#ignore_regions"><code>IGNORE_REGIONS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#internal_errors_as_warnings"><code>INTERNAL_ERRORS_AS_WARNINGS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#intern_names"><code>INTERN_NAMES</code></a></td><td><code>bool</code></td><td><code>true</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#java_home"><code>JAVA_HOME</code></a></td><td><code>Option&lt;String&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#json_communication"><code>JSON_COMMUNICATION</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#log"><code>LOG</code></a></td><td><code>String</code></td><td><code>&quot;&quot;</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#log_dir"><code>LOG_DIR</code></a></td><td><code>String</code></td><td><code>&quot;log&quot;</code></td><td>A*</td></tr>
<tr><td><a href="config/flags.html#log_style"><code>LOG_STYLE</code></a></td><td><code>String</code></td><td><code>&quot;auto&quot;</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#log_smt_wrapper_interaction"><code>LOG_SMT_WRAPPER_INTERACTION</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#max_log_file_name_length"><code>MAX_LOG_FILE_NAME_LENGTH</code></a></td><td><code>usize</code></td><td><code>60</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#min_prusti_version"><code>MIN_PRUSTI_VERSION</code></a></td><td><code>Option&lt;String&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#no_verify"><code>NO_VERIFY</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#no_verify_deps"><code>NO_VERIFY_DEPS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>B</td></tr>
<tr><td><a href="config/flags.html#optimizations"><code>OPTIMIZATIONS</code></a></td><td><code>Vec&lt;String&gt;</code></td><td>&quot;all&quot;</td><td>A</td></tr>
<tr><td><a href="config/flags.html#preserve_smt_trace_files"><code>PRESERVE_SMT_TRACE_FILES</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#print_collected_verification_items"><code>PRINT_COLLECTED_VERIFICATION_ITEMS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#print_counterexample_if_model_is_present"><code>PRINT_COUNTEREXAMPLE_IF_MODEL_IS_PRESENT</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#print_desugared_specs"><code>PRINT_DESUGARED_SPECS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#print_hash"><code>PRINT_HASH</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#print_typeckd_specs"><code>PRINT_TYPECKD_SPECS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#quiet"><code>QUIET</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A*</td></tr>
<tr><td><a href="config/flags.html#server_address"><code>SERVER_ADDRESS</code></a></td><td><code>Option&lt;String&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#server_max_concurrency"><code>SERVER_MAX_CONCURRENCY</code></a></td><td><code>Option&lt;usize&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#server_max_stored_verifiers"><code>SERVER_MAX_STORED_VERIFIERS</code></a></td><td><code>Option&lt;usize&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#simplify_encoding"><code>SIMPLIFY_ENCODING</code></a></td><td><code>bool</code></td><td><code>true</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#skip_unsupported_features"><code>SKIP_UNSUPPORTED_FEATURES</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_qi_bound_global"><code>SMT_QI_BOUND_GLOBAL</code></a></td><td><code>Option&lt;u64&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_qi_bound_global_kind"><code>SMT_QI_BOUND_GLOBAL_KIND</code></a></td><td><code>Option&lt;u64&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_qi_bound_trace"><code>SMT_QI_BOUND_TRACE</code></a></td><td><code>Option&lt;u64&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_qi_bound_trace_kind"><code>SMT_QI_BOUND_TRACE_KIND</code></a></td><td><code>Option&lt;u64&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_qi_ignore_builtin"><code>SMT_QI_IGNORE_BUILTIN</code></a></td><td><code>bool</code></td><td><code>true</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_qi_eager_threshold"><code>SMT_QI_EAGER_THRESHOLD</code></a></td><td><code>u64</code></td><td><code>1000</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_solver_path"><code>SMT_SOLVER_PATH</code></a></td><td><code>Option&lt;String&gt;</code></td><td><code>env::var(&quot;Z3_EXE&quot;)</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_solver_wrapper_path"><code>SMT_SOLVER_WRAPPER_PATH</code></a></td><td><code>Option&lt;String&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_unique_triggers_bound"><code>SMT_UNIQUE_TRIGGERS_BOUND</code></a></td><td><code>Option&lt;u64&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#smt_unique_triggers_bound_total"><code>SMT_UNIQUE_TRIGGERS_BOUND_TOTAL</code></a></td><td><code>Option&lt;u64&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#unsafe_core_proof"><code>UNSAFE_CORE_PROOF</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#use_more_complete_exhale"><code>USE_MORE_COMPLETE_EXHALE</code></a></td><td><code>bool</code></td><td><code>true</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#use_smt_wrapper"><code>USE_SMT_WRAPPER</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#verification_deadline"><code>VERIFICATION_DEADLINE</code></a></td><td><code>Option&lt;u64&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#verify_only_basic_block_path"><code>VERIFY_ONLY_BASIC_BLOCK_PATH</code></a></td><td><code>Vec&lt;String&gt;</code></td><td><code>vec![]</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#verify_only_preamble"><code>VERIFY_ONLY_PREAMBLE</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#viper_backend"><code>VIPER_BACKEND</code></a></td><td><code>String</code></td><td><code>&quot;Silicon&quot;</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#viper_home"><code>VIPER_HOME</code></a></td><td><code>Option&lt;String&gt;</code></td><td><code>None</code></td><td>A</td></tr>
<tr><td><a href="config/flags.html#write_smt_statistics"><code>WRITE_SMT_STATISTICS</code></a></td><td><code>bool</code></td><td><code>false</code></td><td>A</td></tr>
</tbody></table>
</div>
<h2 id="allow_unreachable_unsupported_code"><a class="header" href="#allow_unreachable_unsupported_code"><code>ALLOW_UNREACHABLE_UNSUPPORTED_CODE</code></a></h2>
<p>When enabled, unsupported code is encoded as <code>assert false</code>. This way error messages are reported only for unsupported code that is actually reachable.</p>
<h2 id="assert_timeout"><a class="header" href="#assert_timeout"><code>ASSERT_TIMEOUT</code></a></h2>
<p>Maximum time (in milliseconds) for the verifier to spend on a single assertion. Set to <code>0</code> to disable timeout. Maps to the verifier command-line argument <code>--assertTimeout</code>.</p>
<h2 id="be_rustc"><a class="header" href="#be_rustc"><code>BE_RUSTC</code></a></h2>
<p>When enabled, Prusti will behave like <code>rustc</code>.</p>
<blockquote>
<p><strong>Note:</strong> applied to all dependency crates when running with <code>cargo prusti</code>.</p>
</blockquote>
<h2 id="boogie_path"><a class="header" href="#boogie_path"><code>BOOGIE_PATH</code></a></h2>
<p>A path to Boogie.</p>
<blockquote>
<p><strong>Note:</strong> <code>prusti-rustc</code> sets this option.</p>
</blockquote>
<h2 id="cache_path"><a class="header" href="#cache_path"><code>CACHE_PATH</code></a></h2>
<p>Path to a cache file, where verification cache will be loaded from and saved to. The default empty string disables saving any cache to disk. A path to a file which does not yet exist will result in using an empty cache, but then creating and saving to that location on exit.</p>
<blockquote>
<p><strong>Note:</strong> <code>cargo prusti</code> sets this flag with <code>DEFAULT_PRUSTI_CACHE_PATH=$CARGO_TARGET_DIR/cache.bin</code>.</p>
</blockquote>
<h2 id="cargo_command"><a class="header" href="#cargo_command"><code>CARGO_COMMAND</code></a></h2>
<p>The cargo command to run when checking a crate with <code>cargo prusti</code>. Change to <code>build</code> to export binaries, library files and specs.</p>
<blockquote>
<p><strong>Note:</strong> Applicable only under <code>cargo prusti</code>.</p>
</blockquote>
<h2 id="cargo_path"><a class="header" href="#cargo_path"><code>CARGO_PATH</code></a></h2>
<p>The path to <code>cargo</code> when running <code>cargo prusti</code>. Useful if <code>cargo</code> is not available in the path.</p>
<blockquote>
<p><strong>Note:</strong> Applicable only under <code>cargo prusti</code>.</p>
</blockquote>
<h2 id="check_foldunfold_state"><a class="header" href="#check_foldunfold_state"><code>CHECK_FOLDUNFOLD_STATE</code></a></h2>
<p>When enabled, additional, <em>slow</em>, checks for the <code>fold</code>/<code>unfold</code> algorithm will be generated.</p>
<h2 id="check_overflows"><a class="header" href="#check_overflows"><code>CHECK_OVERFLOWS</code></a></h2>
<p>When enabled, binary operations and numeric casts will be checked for overflows. See <a href="config/../encoding/types-heap.html#i-u-char">integer type encoding</a>.</p>
<h2 id="check_panics"><a class="header" href="#check_panics"><code>CHECK_PANICS</code></a></h2>
<p>When enabled, Prusti will check for an absence of <code>panic!</code>s.</p>
<h2 id="check_timeout"><a class="header" href="#check_timeout"><code>CHECK_TIMEOUT</code></a></h2>
<p>Maximum time (in milliseconds) for the verifier to spend on checks.
Set to None uses the verifier's default value. Maps to the verifier command-line
argument <code>--checkTimeout</code>.
For more information see <a href="https://github.com/viperproject/silicon/blob/4c70514379f89e7ec6f96588290ade32518f0527/src/main/scala/Config.scala#L203">here</a>.</p>
<h2 id="counterexample"><a class="header" href="#counterexample"><code>COUNTEREXAMPLE</code></a></h2>
<p>When enabled, Prusti will try to find and print a counterexample for any failed assertion or specification.</p>
<h2 id="delete_basic_blocks"><a class="header" href="#delete_basic_blocks"><code>DELETE_BASIC_BLOCKS</code></a></h2>
<p>The given basic blocks will be replaced with <code>assume false</code>.</p>
<h2 id="disable_name_mangling"><a class="header" href="#disable_name_mangling"><code>DISABLE_NAME_MANGLING</code></a></h2>
<p>When enabled, Viper name mangling will be disabled.</p>
<blockquote>
<p><strong>Note:</strong> This is very likely to result in invalid programs being generated because of name collisions.</p>
</blockquote>
<h2 id="dump_borrowck_info"><a class="header" href="#dump_borrowck_info"><code>DUMP_BORROWCK_INFO</code></a></h2>
<p>When enabled, borrow checking info will be output.</p>
<h2 id="dump_debug_info"><a class="header" href="#dump_debug_info"><code>DUMP_DEBUG_INFO</code></a></h2>
<p>When enabled, debug files will be created.</p>
<h2 id="dump_debug_info_during_fold"><a class="header" href="#dump_debug_info_during_fold"><code>DUMP_DEBUG_INFO_DURING_FOLD</code></a></h2>
<p>When enabled, the state of the fold-unfold algorithm after each step will be dumped to a file.</p>
<h2 id="dump_path_ctxt_in_debug_info"><a class="header" href="#dump_path_ctxt_in_debug_info"><code>DUMP_PATH_CTXT_IN_DEBUG_INFO</code></a></h2>
<p>When enabled, branch context state will be output in debug files.</p>
<h2 id="dump_reborrowing_dag_in_debug_info"><a class="header" href="#dump_reborrowing_dag_in_debug_info"><code>DUMP_REBORROWING_DAG_IN_DEBUG_INFO</code></a></h2>
<p>When enabled, reborrowing DAGs will be output in debug files.</p>
<h2 id="dump_viper_program"><a class="header" href="#dump_viper_program"><code>DUMP_VIPER_PROGRAM</code></a></h2>
<p>When enabled, the encoded Viper programs will be output.
You can find them either in <code>log/viper_program</code> or <code>target/verify/log/viper_program</code>.</p>
<h2 id="enable_cache"><a class="header" href="#enable_cache"><code>ENABLE_CACHE</code></a></h2>
<p>When enabled, verification requests (to verify individual <code>fn</code>s) are cached to improve future verification. By default the cache is only saved in memory (of the <code>prusti-server</code> if enabled). For long-running verification projects use <a href="config/flags.html#cache_path"><code>CACHE_PATH</code></a> to save to disk.</p>
<h2 id="enable_purification_optimization"><a class="header" href="#enable_purification_optimization"><code>ENABLE_PURIFICATION_OPTIMIZATION</code></a></h2>
<p>When enabled, impure methods are optimized using the purification optimization, which tries to convert heap operations to pure (snapshot-based) operations.</p>
<blockquote>
<p><strong>Note:</strong> This option is highly experimental.</p>
</blockquote>
<h2 id="enable_type_invariants"><a class="header" href="#enable_type_invariants"><code>ENABLE_TYPE_INVARIANTS</code></a></h2>
<p>When enabled, type invariants can be declared on types using the <code>#[invariant(...)]</code> attribute.</p>
<h2 id="enable_verify_only_basic_block_path"><a class="header" href="#enable_verify_only_basic_block_path"><code>ENABLE_VERIFY_ONLY_BASIC_BLOCK_PATH</code></a></h2>
<p>When enabled, only the path given in <a href="config/flags.html#verify_only_basic_block_path"><code>VERIFY_ONLY_BASIC_BLOCK_PATH</code></a> will be verified.</p>
<blockquote>
<p><strong>Note:</strong> This flag is only for debugging Prusti.</p>
</blockquote>
<h2 id="encode_bitvectors"><a class="header" href="#encode_bitvectors"><code>ENCODE_BITVECTORS</code></a></h2>
<p>When enabled, bitwise integer operations are encoded using bitvectors.</p>
<blockquote>
<p><strong>Note:</strong> This option is highly experimental.</p>
</blockquote>
<h2 id="encode_unsigned_num_constraint"><a class="header" href="#encode_unsigned_num_constraint"><code>ENCODE_UNSIGNED_NUM_CONSTRAINT</code></a></h2>
<p>When enabled, non-negativity of unsigned integers will be encoded and checked.</p>
<h2 id="extra_jvm_args"><a class="header" href="#extra_jvm_args"><code>EXTRA_JVM_ARGS</code></a></h2>
<p>Additional arguments to pass to the JVM when launching a verifier backend.</p>
<h2 id="extra_verifier_args"><a class="header" href="#extra_verifier_args"><code>EXTRA_VERIFIER_ARGS</code></a></h2>
<p>Additional arguments to pass to the verifier backend.</p>
<h2 id="foldunfold_state_filter"><a class="header" href="#foldunfold_state_filter"><code>FOLDUNFOLD_STATE_FILTER</code></a></h2>
<p>Filter for <code>fold</code>/<code>unfold</code> nodes when debug info is dumped.</p>
<h2 id="full_compilation"><a class="header" href="#full_compilation"><code>FULL_COMPILATION</code></a></h2>
<p>When enabled, compilation will continue and a binary will be generated after Prusti terminates.</p>
<blockquote>
<p><strong>Note:</strong> <code>cargo prusti</code> sets this flag with <code>DEFAULT_PRUSTI_FULL_COMPILATION=true</code>.</p>
</blockquote>
<h2 id="hide_uuids"><a class="header" href="#hide_uuids"><code>HIDE_UUIDS</code></a></h2>
<p>When enabled, UUIDs of expressions and specifications printed with <a href="config/flags.html#print_typeckd_specs"><code>PRINT_TYPECKD_SPECS</code></a> are hidden.</p>
<h2 id="ignore_regions"><a class="header" href="#ignore_regions"><code>IGNORE_REGIONS</code></a></h2>
<p>When enabled, debug files dumped by <code>rustc</code> will not contain lifetime regions.</p>
<h2 id="internal_errors_as_warnings"><a class="header" href="#internal_errors_as_warnings"><code>INTERNAL_ERRORS_AS_WARNINGS</code></a></h2>
<p>When enabled, internal errors are presented as warnings.</p>
<p><strong>Note</strong>: This should only be used for debugging, as enabling this setting could
hide actual verification errors.</p>
<h2 id="intern_names"><a class="header" href="#intern_names"><code>INTERN_NAMES</code></a></h2>
<p>When enabled, Viper identifiers are interned to shorten them when possible.</p>
<h2 id="java_home"><a class="header" href="#java_home"><code>JAVA_HOME</code></a></h2>
<p>The path the directory containing Java.</p>
<blockquote>
<p><strong>Note:</strong> <code>prusti-rustc</code> sets this option.</p>
</blockquote>
<h2 id="json_communication"><a class="header" href="#json_communication"><code>JSON_COMMUNICATION</code></a></h2>
<p>When enabled, communication with the server will be encoded as JSON instead of the default bincode.</p>
<h2 id="log"><a class="header" href="#log"><code>LOG</code></a></h2>
<p>Log level and filters. See <a href="https://docs.rs/env_logger/0.7.1/env_logger/index.html#enabling-logging"><code>env_logger</code> documentation</a>.</p>
<p>For example, <code>PRUSTI_LOG=prusti_viper=trace</code> enables trace logging for the prusti-viper crate.
Debug and trace logs are not available in release builds.</p>
<h2 id="log_dir"><a class="header" href="#log_dir"><code>LOG_DIR</code></a></h2>
<p>Path to directory in which log files and dumped output will be stored.</p>
<blockquote>
<p><strong>Note:</strong> <code>cargo prusti</code> sets this flag with <code>DEFAULT_PRUSTI_LOG_DIR=$CARGO_TARGET_DIR/log</code>.</p>
</blockquote>
<h2 id="log_style"><a class="header" href="#log_style"><code>LOG_STYLE</code></a></h2>
<p>Log style. See <a href="https://docs.rs/env_logger/0.7.1/env_logger/index.html#disabling-colors"><code>env_logger</code> documentation</a>.</p>
<h2 id="log_smt_wrapper_interaction"><a class="header" href="#log_smt_wrapper_interaction"><code>LOG_SMT_WRAPPER_INTERACTION</code></a></h2>
<p>When enabled, logs all SMT wrapper interaction to a file.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="max_log_file_name_length"><a class="header" href="#max_log_file_name_length"><code>MAX_LOG_FILE_NAME_LENGTH</code></a></h2>
<p>Maximum allowed length of a log file name. If this is exceeded, the file name is truncated.</p>
<h2 id="min_prusti_version"><a class="header" href="#min_prusti_version"><code>MIN_PRUSTI_VERSION</code></a></h2>
<p>Minimum required version of Prusti that is allowed to run. If Prusti detects that its own version is lower than this, it will throw an error and refuse to verify files. Generally <a href="config/providing.html#flags-2">set in a <code>Prusti.toml</code> file</a> of a crate to enforce a minimum Prusti version.</p>
<h2 id="no_verify"><a class="header" href="#no_verify"><code>NO_VERIFY</code></a></h2>
<p>When enabled, verification is skipped altogether, though specs are still exported.</p>
<h2 id="no_verify_deps"><a class="header" href="#no_verify_deps"><code>NO_VERIFY_DEPS</code></a></h2>
<p>When enabled, verification is skipped for dependencies. Equivalent to enabling <code>NO_VERIFY</code> for all dependencies. Remote dependencies from e.g. git/crates.io are already automatically <code>NO_VERIFY</code>.</p>
<blockquote>
<p><strong>Note:</strong> applied to all dependency crates when running with <code>cargo prusti</code>.</p>
</blockquote>
<h2 id="only_memory_safety"><a class="header" href="#only_memory_safety"><code>ONLY_MEMORY_SAFETY</code></a></h2>
<p>When enabled, only the core proof is verified.</p>
<blockquote>
<p><strong>Note:</strong> This should be used only when <code>UNSAFE_CORE_PROOF</code> is enabled.</p>
</blockquote>
<h2 id="optimizations"><a class="header" href="#optimizations"><code>OPTIMIZATIONS</code></a></h2>
<p>Comma-separated list of optimizations to enable, or <code>&quot;all&quot;</code> to enable all. Possible values in the list are:</p>
<ul>
<li><code>&quot;inline_constant_functions&quot;</code></li>
<li><code>&quot;delete_unused_predicates&quot;</code></li>
<li><code>&quot;optimize_folding&quot;</code></li>
<li><code>&quot;remove_empty_if&quot;</code></li>
<li><code>&quot;purify_vars&quot;</code></li>
<li><code>&quot;fix_quantifiers&quot;</code></li>
<li><code>&quot;fix_unfoldings&quot;</code></li>
<li><code>&quot;remove_unused_vars&quot;</code></li>
<li><code>&quot;remove_trivial_assertions&quot;</code></li>
<li><code>&quot;clean_cfg&quot;</code></li>
</ul>
<h2 id="preserve_smt_trace_files"><a class="header" href="#preserve_smt_trace_files"><code>PRESERVE_SMT_TRACE_FILES</code></a></h2>
<p>When enabled, does not delete Z3 trace files.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="print_collected_verification_items"><a class="header" href="#print_collected_verification_items"><code>PRINT_COLLECTED_VERIFICATION_ITEMS</code></a></h2>
<p>When enabled, prints the items collected for verification.</p>
<h2 id="print_counterexample_if_model_is_present"><a class="header" href="#print_counterexample_if_model_is_present"><code>PRINT_COUNTEREXAMPLE_IF_MODEL_IS_PRESENT</code></a></h2>
<p>When enabled, a counterexample contains values for the original type and its model.</p>
<h2 id="print_desugared_specs"><a class="header" href="#print_desugared_specs"><code>PRINT_DESUGARED_SPECS</code></a></h2>
<p>When enabled, prints the AST with desugared specifications.</p>
<h2 id="print_hash"><a class="header" href="#print_hash"><code>PRINT_HASH</code></a></h2>
<p>When enabled, prints the hash of a verification request (the hash is used for caching). This is a debugging option which does not perform verification — it is similar to <a href="config/flags.html#no_verify"><code>NO_VERIFY</code></a>, except that this flag stops the verification process at a later stage.</p>
<h2 id="print_typeckd_specs"><a class="header" href="#print_typeckd_specs"><code>PRINT_TYPECKD_SPECS</code></a></h2>
<p>When enabled, prints the type-checked specifications.</p>
<h2 id="quiet"><a class="header" href="#quiet"><code>QUIET</code></a></h2>
<p>When enabled, user messages are not printed. Otherwise, messages output into <code>stderr</code>.</p>
<blockquote>
<p><strong>Note:</strong> <code>cargo prusti</code> sets this flag with <code>DEFAULT_PRUSTI_QUIET=true</code>.</p>
</blockquote>
<h2 id="server_address"><a class="header" href="#server_address"><code>SERVER_ADDRESS</code></a></h2>
<p>When set to an address and port (e.g. <code>&quot;127.0.0.1:2468&quot;</code>), Prusti will connect to the given server and use it for its verification backend.</p>
<p>When set to <code>&quot;MOCK&quot;</code>, the server is run off-thread, effectively mocking connecting to a server without having to start it up separately.</p>
<h2 id="server_max_concurrency"><a class="header" href="#server_max_concurrency"><code>SERVER_MAX_CONCURRENCY</code></a></h2>
<p>Maximum amount of verification requests the server will work on concurrently. If not set, defaults to the number of (logical) cores on the system.</p>
<h2 id="server_max_stored_verifiers"><a class="header" href="#server_max_stored_verifiers"><code>SERVER_MAX_STORED_VERIFIERS</code></a></h2>
<p>Maximum amount of instantiated Viper verifiers the server will keep around for reuse. If not set, defaults to <code>SERVER_MAX_CONCURRENT_VERIFICATION_OPERATIONS</code>. It also doesn't make much sense to set this option to less than that, since then the server will likely have to keep creating new verifiers, reducing the performance gained from reuse.</p>
<blockquote>
<p><strong>Note:</strong> This does <em>not</em> limit how many verification requests the server handles concurrently, only the size of what is essentially its verifier cache.</p>
</blockquote>
<h2 id="simplify_encoding"><a class="header" href="#simplify_encoding"><code>SIMPLIFY_ENCODING</code></a></h2>
<p>When enabled, the encoded program is simplified before it is passed to the Viper backend.</p>
<h2 id="skip_unsupported_features"><a class="header" href="#skip_unsupported_features"><code>SKIP_UNSUPPORTED_FEATURES</code></a></h2>
<p>When enabled, features not supported by Prusti will be reported as warnings rather than errors.</p>
<h2 id="smt_qi_bound_global"><a class="header" href="#smt_qi_bound_global"><code>SMT_QI_BOUND_GLOBAL</code></a></h2>
<p>If not <code>None</code>, checks that the number of global quantifier instantiations reported by the SMT wrapper is smaller than the specified bound.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="smt_qi_bound_global_kind"><a class="header" href="#smt_qi_bound_global_kind"><code>SMT_QI_BOUND_GLOBAL_KIND</code></a></h2>
<p>If not <code>None</code>, checks that the number of global quantifier instantiations for each quantifier reported by the SMT wrapper is smaller than the specified bound.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="smt_qi_bound_trace"><a class="header" href="#smt_qi_bound_trace"><code>SMT_QI_BOUND_TRACE</code></a></h2>
<p>If not <code>None</code>, checks that the number of quantifier instantiations in each trace reported by the SMT wrapper is smaller than the specified bound.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="smt_qi_bound_trace_kind"><a class="header" href="#smt_qi_bound_trace_kind"><code>SMT_QI_BOUND_TRACE_KIND</code></a></h2>
<p>If not <code>None</code>, checks that the number of quantifier instantiations in each trace for each quantifier reported by the SMT wrapper is smaller than the specified bound.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="smt_qi_ignore_builtin"><a class="header" href="#smt_qi_ignore_builtin"><code>SMT_QI_IGNORE_BUILTIN</code></a></h2>
<p>When enabled, ignores the built-in quantifiers in SMT quantifier instantiation bounds checking.</p>
<h2 id="smt_qi_eager_threshold"><a class="header" href="#smt_qi_eager_threshold"><code>SMT_QI_EAGER_THRESHOLD</code></a></h2>
<p>A threshold controlling how many times Z3 should instantiate a single quantifier. This option controls a tradeoff between performance and completeness:</p>
<ul>
<li>Setting it to a too small value, may lead to spurious verification errors and unstable verification.</li>
</ul>
<ul>
<li>Setting it to a too large value, may significantly impact performance.</li>
</ul>
<h2 id="smt_solver_path"><a class="header" href="#smt_solver_path"><code>SMT_SOLVER_PATH</code></a></h2>
<p>Path to Z3.</p>
<blockquote>
<p><strong>Note:</strong> <code>prusti-rustc</code> sets this option.</p>
</blockquote>
<h2 id="smt_solver_wrapper_path"><a class="header" href="#smt_solver_wrapper_path"><code>SMT_SOLVER_WRAPPER_PATH</code></a></h2>
<p>A path to <code>prusti-smt-solver</code>.</p>
<blockquote>
<p><strong>Note:</strong> <code>prusti-rustc</code> sets this option.</p>
</blockquote>
<h2 id="smt_unique_triggers_bound"><a class="header" href="#smt_unique_triggers_bound"><code>SMT_UNIQUE_TRIGGERS_BOUND</code></a></h2>
<p>If not <code>None</code>, checks that the number of unique triggers used for each quantifier reported by the SMT wrapper is smaller than the specified bound.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="smt_unique_triggers_bound_total"><a class="header" href="#smt_unique_triggers_bound_total"><code>SMT_UNIQUE_TRIGGERS_BOUND_TOTAL</code></a></h2>
<p>If not <code>None</code>, checks that the total number of unique triggers reported by the SMT wrapper is smaller than the specified bound.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<h2 id="unsafe_core_proof"><a class="header" href="#unsafe_core_proof"><code>UNSAFE_CORE_PROOF</code></a></h2>
<p>When enabled, the new core proof is used, suitable for unsafe code</p>
<blockquote>
<p><strong>Note:</strong> This option is currently very incomplete.</p>
</blockquote>
<h2 id="use_more_complete_exhale"><a class="header" href="#use_more_complete_exhale"><code>USE_MORE_COMPLETE_EXHALE</code></a></h2>
<p>When enabled, a more complete <code>exhale</code> version is used in the verifier. See <a href="https://github.com/viperproject/silicon/blob/f48de7f6e2d90d9020812869c713a5d3e2035995/src/main/scala/rules/StateConsolidator.scala#L29-L46"><code>consolidate</code></a>. Equivalent to the verifier command-line argument <code>--enableMoreCompleteExhale</code>.</p>
<h2 id="use_smt_wrapper"><a class="header" href="#use_smt_wrapper"><code>USE_SMT_WRAPPER</code></a></h2>
<p>Whether to use the SMT solver wrapper. Enabling this is required to be able to use quantifier instantiation bounds checking.</p>
<p>This flag is intended to be used in tests only.</p>
<h2 id="verification_deadline"><a class="header" href="#verification_deadline"><code>VERIFICATION_DEADLINE</code></a></h2>
<p>Deadline (in seconds) within which Prusti should encode and verify the program.</p>
<p>Prusti panics if it fails to meet this deadline. This flag is intended to be used for tests that aim to catch performance regressions.</p>
<h2 id="verify_only_basic_block_path"><a class="header" href="#verify_only_basic_block_path"><code>VERIFY_ONLY_BASIC_BLOCK_PATH</code></a></h2>
<p>Verify only the single execution path goes through the given basic blocks. All basic blocks not on this execution path are replaced with <code>assume false</code>. Must be enabled using the <a href="config/flags.html#enable_verify_only_basic_block_path"><code>ENABLE_VERIFY_ONLY_BASIC_BLOCK_PATH</code></a> flag.</p>
<blockquote>
<p><strong>Note:</strong> This option is only for debugging Prusti.</p>
</blockquote>
<h2 id="verify_only_preamble"><a class="header" href="#verify_only_preamble"><code>VERIFY_ONLY_PREAMBLE</code></a></h2>
<p>When enabled, only the preamble will be verified: domains, functions, and predicates.</p>
<blockquote>
<p><strong>Note:</strong> With this flag enabled, no methods are verified!</p>
</blockquote>
<h2 id="viper_backend"><a class="header" href="#viper_backend"><code>VIPER_BACKEND</code></a></h2>
<p>Verification backend to use. Possible values:</p>
<ul>
<li><code>Carbon</code> - verification-condition-generation-based backend <a href="https://github.com/viperproject/carbon">Carbon</a>.</li>
<li><code>Silicon</code> - symbolic-execution-based backend <a href="https://github.com/viperproject/silicon/">Silicon</a>.</li>
</ul>
<h2 id="viper_home"><a class="header" href="#viper_home"><code>VIPER_HOME</code></a></h2>
<p>The path the directory containing the Viper JARs.</p>
<blockquote>
<p><strong>Note:</strong> <code>prusti-rustc</code> sets this option.</p>
</blockquote>
<h2 id="write_smt_statistics"><a class="header" href="#write_smt_statistics"><code>WRITE_SMT_STATISTICS</code></a></h2>
<p>When enabled, dumps the statistics collected by the SMT wrapper into files next to the Z3 trace files.</p>
<blockquote>
<p><strong>Note:</strong> Requires <code>USE_SMT_WRAPPER</code> to be <code>true</code>.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="verification-pipeline"><a class="header" href="#verification-pipeline">Verification Pipeline</a></h1>
<p>At a high level, Prusti is a plugin to the <a href="https://rustc-dev-guide.rust-lang.org/">Rust compiler</a> that converts Rust code enriched with Prusti specifications into <a href="https://viper.ethz.ch">Viper code</a>, verifies the code with an external verifier, and then reports the results back to the user.</p>
<p>This chapter summarizes the steps that take place when the user runs Prusti on a given Rust file. The steps are described in greater detail in the subsequent sections. Although we present the steps in separate “stages”, this distinction only exists for the purposes of this guide, and is not clearly mirrored in the codebase.</p>
<ol>
<li><a href="pipeline/binary.html">Binary stage</a>
<ul>
<li>The user invokes the binary <code>prusti-rustc &lt;file.rs&gt;</code>.</li>
<li>The binary sets up important environment variables, then invokes <code>prusti_driver</code>.</li>
</ul>
</li>
<li><a href="pipeline/rust.html">Rust compilation stage</a>
<ul>
<li><code>prusti_driver</code> registers callbacks and calls the Rust compiler.</li>
<li>The compiler expands all procedural macros, which includes the specifications.</li>
<li>The compiler does the type-checking.</li>
<li>The Prusti callback is called.</li>
</ul>
</li>
<li><a href="pipeline/prusti.html">Prusti processing stage</a>
<ul>
<li>The <a href="https://rustc-dev-guide.rust-lang.org/mir/index.html">MIR</a> of functions that should be checked is obtained.</li>
<li>MIR is encoded into VIR - Prusti's intermediate representation.</li>
<li>VIR is enriched with <code>fold</code>/<code>unfold</code> statements and other ghost code.</li>
<li>VIR is simplified and optimized.</li>
</ul>
</li>
<li><a href="pipeline/viper.html">Viper verification stage</a>
<ul>
<li>(With Prusti server only) Send VIR to the server.</li>
<li>VIR is encoded into Viper.</li>
<li>The Viper verifier is called and the results are obtained.</li>
<li>(With Prusti server only) Send verification results back to the client.</li>
</ul>
</li>
<li><a href="pipeline/report.html">Reporting stage</a>
<ul>
<li>The Prusti client reports compilation and verification errors.</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="binary-stage"><a class="header" href="#binary-stage">Binary stage</a></h1>
<ul>
<li>The user invokes the binary <code>prusti-rustc &lt;file.rs&gt;</code>.</li>
<li>The binary sets up important environment variables, then invokes <code>prusti_driver</code>.</li>
</ul>
<p>This is a short stage responsible for setting up the correct environment variables for the Rust compiler and the Prusti-supporting libraries. To invoke <code>prusti-driver</code> correctly, the following arguments are set up:</p>
<ul>
<li><code>--sysroot</code>, pointing to the Rust sysroot where its libraries are stored.</li>
<li><code>-L</code>, adding Prusti's <code>target/*/deps</code> directory into the library search path.</li>
<li><code>--extern prusti_contracts=...</code> and <code>--extern prusti_contracts_internal=...</code>, specifying the path for the dynamic libraries containing the procedural macros for Prusti specifications.</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti/src/bin/prusti-rustc.rs"><code>prusti/src/bin/prusti-rustc.rs</code></a></li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-compilation-stage"><a class="header" href="#rust-compilation-stage">Rust compilation stage</a></h1>
<ul>
<li><code>prusti_driver</code> registers callbacks and calls the Rust compiler.</li>
<li>The compiler expands all <a href="pipeline/../macros.html">procedural macros</a>, which includes the specifications.</li>
<li>The compiler does the type-checking.</li>
<li>The Prusti callback is called.</li>
</ul>
<p>In this stage, the actual Rust compiler is invoked to make sure the given code is valid Rust code, both syntactically and semantically. Prusti integrates with the Rust compiler using <a href="https://rustc-dev-guide.rust-lang.org/rustc-driver.html"><code>rustc_driver</code></a>. This allows running the Rust compiler with <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_driver/trait.Callbacks.html">callbacks</a> triggered when important stages of processing are completed. In Prusti, we are interested in two stages:</p>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/f6850c5036c4a85c8812b46eed8ac472ca95fe25/prusti/src/callbacks.rs#L58"><code>prusti/src/callbacks.rs</code> - <code>PrustiCompilerCalls::after_expansion</code></a> - for debugging and unit testing purposes, it is useful to see the Rust AST after the Prusti specifications are processed.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/f6850c5036c4a85c8812b46eed8ac472ca95fe25/prusti/src/callbacks.rs#L89"><code>prusti/src/callbacks.rs</code> - <code>PrustiCompilerCalls::after_analysis</code></a> - once the type checking is done and the code is determined to be type safe. Code that is syntactically invalid or has type errors is not relevant for Prusti applications.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prusti-processing-stage"><a class="header" href="#prusti-processing-stage">Prusti processing stage</a></h1>
<ul>
<li>The MIR of functions that should be checked is obtained.</li>
<li>MIR is encoded into VIR - Prusti's intermediate representation.</li>
<li>VIR is enriched with <code>fold</code>/<code>unfold</code> statements and other ghost code.</li>
<li>VIR is simplified and optimized.</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti/src/verifier.rs#L15-L72"><code>prusti/src/verifier.rs</code> - <code>verify</code></a> - function combining the steps in this stage.</li>
</ul>
</blockquote>
<h2 id="mir-and-vir"><a class="header" href="#mir-and-vir">MIR and VIR</a></h2>
<p>Prusti starts with Rust's <a href="https://rustc-dev-guide.rust-lang.org/mir/index.html">MIR (mid-level intermediate representation)</a>. The MIR is a <a href="https://en.wikipedia.org/wiki/Control-flow_graph">CFG</a>-based representation that encodes Rust in a highly simplified (and therefore easier to programmatically process) manner.</p>
<p>The output of this stage is VIR (Viper intermediate representation). The VIR is similar to Viper AST, but it is CFG-based and contains some extra instructions to aid the generation of <code>fold</code>/<code>unfold</code> statements. The conversion of VIR to Viper AST is straight-forward by design.</p>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/ast"><code>prusti-common/src/vir/ast</code></a> - definitions of most VIR data structures, e.g. expressions.</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/ast"><code>prusti-common/src/vir/cfg</code></a> - definitions of the CFG-specific parts of VIR, i.e. methods composed of a graph of basic blocks.</li>
</ul>
</blockquote>
<h2 id="finding-functions-to-check"><a class="header" href="#finding-functions-to-check">Finding functions to check</a></h2>
<p>In this step, functions to be checked are found by visiting the HIR with a visitor that looks for Prusti-defined attributes.</p>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-interface/src/environment/mod.rs#L156-L161"><code>prusti-interface/src/environment/mod.rs</code> - <code>Environment::get_annotated_procedures</code></a></li>
</ul>
</blockquote>
<h2 id="encoding-mir-to-vir"><a class="header" href="#encoding-mir-to-vir">Encoding MIR to VIR</a></h2>
<p>In this step, Rust MIR is encoded to VIR. Pure functions are treated separately, since they may be used in specifications. The details of this encoding are complex, but a high-level overview can be found in the <a href="http://pm.inf.ethz.ch/publications/getpdf.php?bibname=Own&amp;id=AstrauskasMuellerPoliSummers19.pdf#appendix.A">Prusti publication, Appendix A</a>.</p>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/verifier.rs#L237-L241"><code>prusti-viper/src/verifier.rs</code> - <code>Verifier::verify</code></a> - initialisation of the encoding queue.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/encoder/encoder.rs#L1653-L1682"><code>prusti-viper/src/encoder/encoder.rs</code> - <code>Encoder::process_encoding_queue</code></a> - processing loop for the encoding queue.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/encoder/procedure_encoder.rs"><code>prusti-viper/src/encoder/procedure_encoder.rs</code></a> - module for encoding impure functions.</li>
</ul>
</blockquote>
<h2 id="vir-processing"><a class="header" href="#vir-processing">VIR processing</a></h2>
<p>At the end of procedure encoding, <code>fold</code>/<code>unfold</code> statements are added. The VIR may also be optimized, e.g. by removing empty branches in <code>if</code> chains.</p>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/encoder/foldunfold/mod.rs"><code>prusti-viper/src/encoder/foldunfold/mod.rs</code></a> - <code>fold</code>/<code>unfold</code> logic.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/verifier.rs#L246-L249"><code>prusti-viper/src/verifier.rs</code> - <code>Verifier::verify</code></a> - optional optimization.</li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="viper-verification-stage"><a class="header" href="#viper-verification-stage">Viper verification stage</a></h1>
<ul>
<li>(With Prusti server only) Send VIR to the server.</li>
<li>VIR is encoded into Viper.</li>
<li>The Viper verifier is called and the results are obtained.</li>
<li>(With Prusti server only) Send verification results back to the client.</li>
</ul>
<h2 id="prusti-server"><a class="header" href="#prusti-server">Prusti server</a></h2>
<p><a href="https://github.com/viperproject/prusti-dev/pull/43">Prusti server</a> is an optional component of Prusti that can significantly reduce verification times by running a background process. The background process keeps an instance of JVM open, which is what Viper backends use to perform verification of Viper code. With the server enabled, a client only needs to send VIR to the server and receive the results once they are ready.</p>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/verifier.rs#L259-L281"><code>prusti-viper/src/verifier.rs</code> - <code>Verifier::verify</code></a> - verification with the server.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/verifier.rs#L281-L288"><code>prusti-viper/src/verifier.rs</code> - <code>Verifier::verify</code></a> - verification without the server.</li>
</ul>
</blockquote>
<h2 id="encoding-vir-to-viper"><a class="header" href="#encoding-vir-to-viper">Encoding VIR to Viper</a></h2>
<p>As noted in <a href="pipeline/prusti.html#encoding-mir-to-vir">the previous section</a>, VIR is an intermediate representation separate from Viper AST. In this step the encoding from one to the other is performed.</p>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-server/src/verifier_runner.rs#L60"><code>prusti-server/src/verifier_runner.rs</code> - <code>VerifierRunner::verify</code></a> - call to <code>to_viper</code>.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-common/src/vir/to_viper.rs"><code>prusti-common/src/vir/to_viper.rs</code></a> - implementation of <code>ToViper</code> trait.</li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reporting-stage"><a class="header" href="#reporting-stage">Reporting stage</a></h1>
<ul>
<li>The Prusti client reports compilation and verification errors.</li>
</ul>
<p>In this final stage, any errors and warnings that occurred during verification are reported to the user.</p>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/verifier.rs#L292-L317"><code>prusti-viper/src/verifier.rs</code> - <code>Verifier::verify</code></a> - collection of errors from verification call.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/143e673dc19b4c1363efade90ffee4f77641ec11/prusti-viper/src/encoder/errors/prusti_error.rs#L95"><code>prusti-viper/src/encoder/errors/prusti_error.rs</code> - <code>PrustiError::emit</code></a> - emission of Prusti errors as messages and source file spans into the compiler environment.</li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="macros"><a class="header" href="#macros">Macros</a></h1>
<p>Prusti makes use of <a href="https://doc.rust-lang.org/reference/procedural-macros.html">procedural macros</a> as the interface for user-provided specifications.</p>
<h2 id="specification-syntax"><a class="header" href="#specification-syntax">Specification syntax</a></h2>
<p>Prusti <a href="https://viperproject.github.io/prusti-dev/user-guide/syntax.html">specification syntax</a> is a superset of Rust boolean expressions. The parsing of Prusti-specific syntax is achieved with a custom preparser. Parsing of Rust syntax is delegated to the <a href="https://crates.io/crates/syn"><code>syn</code></a> crate.</p>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/f3ce1acd3c38e9c60d94fbdd7ebc1fcbeb316067/prusti-specs/src/specifications/preparser.rs"><code>prusti-specs/src/specifications/preparser.rs</code></a></li>
</ul>
<p>The preparser accepts the following EBNF grammar:</p>
<pre><code class="language-ebnf">assertion ::= prusti_expr ;
pledge ::= pledge_lhs, &quot;,&quot;, prusti_expr ;
pledge_lhs ::= [ ? actual rust expression ?, &quot;=&gt;&quot; ], prusti_expr ;
 
prusti_expr ::= conjunction, [ &quot;==&gt;&quot;, prusti_expr ] ;
conjunction ::= entailment, { &quot;&amp;&amp;&quot;, entailment } ;
entailment ::= primary | ? actual rust expression ?, [ &quot;|=&quot;, [ &quot;|&quot;, ? args as parsed by syn2 ?, &quot;|&quot; ], &quot;[&quot;, [ ( requires | ensures ), { &quot;,&quot;, ( requires | ensures ) } ], &quot;]&quot; ] ;
primary ::= &quot;(&quot;, prusti_expr, &quot;)&quot;
          | &quot;forall&quot;, &quot;(&quot;, &quot;|&quot;, ? one or more args as parsed by syn2 ?, &quot;|&quot;, prusti_expr, [ &quot;,&quot;, &quot;triggers&quot;, &quot;=&quot;, ? array as parsed by syn2 ? ] &quot;)&quot;
          ;
requires ::= &quot;requires&quot;, &quot;(&quot;, prusti_expr, &quot;)&quot; ;
ensures ::= &quot;ensures&quot;, &quot;(&quot;, prusti_expr, &quot;)&quot; ;
</code></pre>
<h2 id="specification-serialization"><a class="header" href="#specification-serialization">Specification serialization</a></h2>
<p>Because procedural macros are executed in a separate, sandboxed process, it is not straight-forward to pass data from procedural macros to the rest of the <a href="pipeline/summary.html">Prusti pipeline</a>. Any collected data (e.g. parsed assertions) is therefore serialized and inserted into the processed HIR as attributes on dummy functions, where it can be picked up by a HIR visitor.</p>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/f3ce1acd3c38e9c60d94fbdd7ebc1fcbeb316067/prusti-specs/src/rewriter.rs"><code>prusti-specs/src/rewriter.rs</code></a> - rewriter, generates functions with serialized specifications.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/f3ce1acd3c38e9c60d94fbdd7ebc1fcbeb316067/prusti-interface/src/specs/mod.rs#L41"><code>prusti-interface/src/specs/mod.rs</code> - <code>SpecCollector</code></a> - specification collector, implements <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/intravisit/trait.Visitor.html"><code>intravisit::Visitor</code></a> for walking the HIR.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="viper-encoding"><a class="header" href="#viper-encoding">Viper Encoding</a></h1>
<p>This chapter details how particular features of the Rust language are encoded into Viper.</p>
<ul>
<li><a href="encoding/types.html">Types</a>
<ul>
<li><a href="encoding/types-heap.html">Heap-based type encoding</a></li>
<li><a href="encoding/types-snap.html">Snapshot-based type encoding</a></li>
</ul>
</li>
<li><a href="encoding/pure.html">Pure function encoding</a></li>
<li><a href="encoding/mangling.html">Name mangling</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="types"><a class="header" href="#types">Types</a></h1>
<p>This section describes how Rust types are encoded into Viper. There are two methods used in Prusti:</p>
<ul>
<li><a href="encoding/types-heap.html">Heap-based encoding</a></li>
<li><a href="encoding/types-snap.html">Snapshot-based encoding</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="heap-based-type-encoding"><a class="header" href="#heap-based-type-encoding">Heap-based type encoding</a></h1>
<p>This encoding uses Viper <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#predicates">predicates</a> and <code>Ref</code>s.</p>
<h2 id="primitive-types"><a class="header" href="#primitive-types">Primitive types</a></h2>
<p>A small number of Rust types have direct analogues in the Viper type system. However, because it is possible to reference local variables and arguments in Rust, all variables are encoded as <code>Ref</code>s, and specific fields are used to refer to the &quot;primitive value&quot; contained in those <code>Ref</code>s.</p>
<h3 id="bool"><a class="header" href="#bool"><code>Bool</code></a></h3>
<p><code>Bool</code> is encoded to Viper <code>Bool</code>.</p>
<pre><code class="language-viper">field val_bool: Bool
predicate bool(self: Ref) {
  acc(self.val_bool, write)
}
</code></pre>
<h3 id="i-u-char"><a class="header" href="#i-u-char"><code>i*</code>, <code>u*</code>, <code>char</code></a></h3>
<p>All Rust integers (<code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>i128</code>, <code>isize</code>, <code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>u128</code>, <code>usize</code>) and <code>char</code> are encoded to Viper <code>Int</code>.</p>
<pre><code class="language-viper">field val_int: Int
predicate i32(self: Ref) {
  acc(self.val_int, write)
}
</code></pre>
<p>When the <a href="encoding/../config/flags.html#check_overflows"><code>CHECK_OVERFLOWS</code></a> flag is enabled, integer bounds are encoded with the type.</p>
<pre><code class="language-viper">// with CHECK_OVERFLOWS
predicate i32(self: Ref) {
  acc(self.val_int, write) &amp;&amp; -2147483648 &lt;= self.val_int &amp;&amp; self.val_int &lt;= 2147483647
}
</code></pre>
<p>When the <a href="encoding/../config/flags.html#encode_unsigned_num_constraint"><code>ENCODE_UNSIGNED_NUM_CONSTRAINT</code></a> flag is enabled (even when <code>CHECK_OVERFLOWS</code> is not), non-negativity of unsigned integers is always encoded.</p>
<pre><code class="language-viper">// with ENCODE_UNSIGNED_NUM_CONSTRAINT
predicate u32(self: Ref) {
  acc(self.val_int, write) &amp;&amp; 0 &lt;= self.val_int
}
</code></pre>
<h2 id="composite-types"><a class="header" href="#composite-types">Composite types</a></h2>
<p>There are no classes in Viper (every <code>Ref</code> instance has all fields), so non-primitive Rust types are encoded as predicates composed of multiple components.</p>
<h3 id="tuples"><a class="header" href="#tuples">Tuples</a></h3>
<p>Each component of a tuple is a field of type <code>Ref</code>, named <code>tuple_0</code>, <code>tuple_1</code>, etc. The type of each component is encoded recursively.</p>
<pre><code class="language-viper">field tuple_0: Ref
field tuple_1: Ref
// ...

// for some types X and Y
predicate Tuple_X_Y(self: Ref) {
  acc(self.tuple_0, write) &amp;&amp; X(self.tuple_0) &amp;&amp;
  acc(self.tuple_1, write) &amp;&amp; Y(self.tuple_1)
}
</code></pre>
<h3 id="structures"><a class="header" href="#structures">Structures</a></h3>
<p>Structures are encoded similarly to tuples, except that fields names correspond to the names defined in the Rust type.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// for a Rust type, assuming types X and Y are defined
struct SomeStruct {
  a: X,
  b: Y,
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-viper">field SomeStruct_a: Ref
field SomeStruct_b: Ref
predicate SomeStruct(self:Ref) {
  acc(self.SomeStruct_a, write) &amp;&amp; X(self.SomeStruct_a) &amp;&amp;
  acc(self.SomeStruct_b, write) &amp;&amp; Y(self.SomeStruct_b)
}
</code></pre>
<h3 id="enumerations"><a class="header" href="#enumerations">Enumerations</a></h3>
<p>Enumerations (ADTs) have values corresponding to one of their variants. Each variant can hold different types of data, so the Viper encoding contains implications of the form &quot;if the variant of the value is X, the value contains the following fields&quot;. The variant index is encoded as the <code>discriminant</code> field.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// for a Rust type, assuming type X is defined
enum SomeEnum {
  Foo,
  Bar(X),
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-viper">field discriminant: Int
field elt0: Ref
// ...

predicate SomeEnum(self: Ref) {
  acc(self.discriminant, write) &amp;&amp;
  0 &lt;= self.discriminant &amp;&amp; self.discriminant &lt;= 1 &amp;&amp;
  // variant `Foo`
  (self.discriminant == 0 ==&gt; true) &amp;&amp;
  // variant `Bar(X)`
  (self.discriminant == 1 ==&gt; acc(self.elt0, write) &amp;&amp; X(self.elt0))
}
</code></pre>
<h3 id="references"><a class="header" href="#references">References</a></h3>
<p>Rust references, mutable or otherwise, are encoded using the <code>val_ref</code> field.</p>
<pre><code class="language-viper">field val_ref: Ref

// for some Rust type X, &amp;mut X is the following
predicate RefMutX(self: Ref) {
  acc(self.val_ref, write) &amp;&amp; X(self.val_ref)
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="snapshot-based-type-encoding"><a class="header" href="#snapshot-based-type-encoding">Snapshot-based type encoding</a></h1>
<p>Prusti's <a href="encoding/types-heap.html">default encoding of types</a> heavily relies on the heap component of the Viper program state to model parts of Rust's ownership system through <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#permissions">permissions</a>.</p>
<p>However, some Viper features do not work well with Prusti's heap-based encoding.
For example, <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#quantifiers">quantification</a> over structs is problematic because they are encoded using predicates instead of heap-independent types.
Similarly, since <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#functions">Viper functions</a> must not have resource assertions in their postconditions, the heap-based encoding prevents modeling pure Rust functions that return (copyable) structures.</p>
<p>Prusti uses an alternative encoding of most types - called the <em>snapshot</em>-based encoding - to circumvent these issues. 
Snapshots use <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#domains">Viper domains</a> to model each Rust type as a new (heap-independent) type in Viper
instead of relying on <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#predicates">Viper predicates</a>.</p>
<p>The snapshot-based encoding of a Rust type, say <code>T</code>, consists of four components:</p>
<ol>
<li>A <em>domain type</em> <code>Snap$T</code> representing the Rust type <code>T</code>.
Instances of <code>Snap$T</code> can be thought of as deep values representing a Rust value of type <code>T</code>.</li>
<li>A <em>constructor</em> function <code>cons$T</code> (for each variant of <code>T</code>) that takes all values that make up a Rust value of type <code>T</code> and returns the corresponding deep value of type <code>Snap$T</code>.</li>
<li><em>Axioms</em> that ensure that each Rust value of type <code>T</code> corresponds to exactly one deep value of type <code>Snap$T</code> and the other way around, i.e., there is a bijection between instances of the Rust type and its snapshot encoding.</li>
<li>A heap-dependent <em>snapshot function</em> that converts the heap-based encoding of a Rust value of type <code>T</code> into a heap-independent representation of type <code>Snap$T</code>.</li>
</ol>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>Consider the Rust struct declared below.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct SomeStruct {
  a: i32,
  b: i32,
}
<span class="boring">}</span></code></pre></pre>
<p>Prusti generates the following Viper domain covering components (1) - (3) for the above function. In particular, the single axiom ensures that two instances of <code>Snap$SomeStruct</code> are equal if and only if all of their underlying components are equal; the &quot;only if&quot; direction is implicit because the constructor is a function and thus produces the same value whenever the same arguments are supplied.</p>
<pre><code class="language-viper">domain Snap$SomeStruct { // (1)
 
  // (2) 
  function cons$SomeStruct(a: Int, b: Int): Snap$SomeStruct

  // (3)
  axiom Snap$SomeStruct$injectivity {
    forall
      a1: Int, b1: Int, a2: Int, b2: Int :: { cons$SomeStruct(a1, b1), cons$SomeStruct(a2, b2) }
      cons$SomeStruct(a1, b1) == cons$SomeStruct(a2, b2) ==&gt; a1 == a2 &amp;&amp; b1 == b2
  }

}
</code></pre>
<p>To guarantee that there is a bijection between instances of <code>SomeStruct</code> and <code>Snap$SomeStruct</code> one needs, in principle, another axiom formalizing that every instance of <code>Snap$SomeStruct</code> corresponds to an application of the constructor function; a corresponding axiom is found below. However, we never encountered a case in which the axiom is actually needed. Prusti thus does not generate it at the moment.</p>
<pre><code class="language-viper">axiom Snap$SomeStruct$surjectivity {
  forall
    s: Snap$SomeStruct ::
    (forall a: Int, b: Int :: {cons$SomeStruct(a, b)} s != cons$SomeStruct(a, b)) ==&gt; false
}
</code></pre>
<p>Finally, component (4), i.e., the heap-dependent function for converting instances of <code>SomeStruct</code> in the heap-based encoding into the snapshot-based representation, is defined as follows:</p>
<pre><code class="language-viper">// (4)
function snap$SomeStruct(self: Ref): Snap$SomeStruct
  requires acc(SomeStruct(self, read$()))
{
  unfolding acc(SomeStruct(self, read$())) in
    cons$SomeStruct(snap$i32(self.SomeStruct_a), snap$i32(self.SomeStruct_b))
}
</code></pre>
<p>The above function recursively unfolds all predicates involved in the encoding of <code>SomeStruct</code>.
It then calls the constructor of <code>Snap$SomeStruct</code>. Furthermore, for each argument, it calls the <code>snap$</code> function of the argument's type to obtain a heap-independent deep value instead of a reference.</p>
<h2 id="primitive-types-1"><a class="header" href="#primitive-types-1">Primitive types</a></h2>
<p>Prusti also generates <code>snap$</code> functions for primitive types such that we do not have to check whether a type is primitive or not; these functions return the primitive type itself instead of a domain type. For instance, the function <code>snap$i32</code> used in the above example is defined as follows:</p>
<pre><code class="language-viper">function snap$i32(self: Ref): Int
  requires acc(i32(self), read$())
{
  unfolding acc(i32(self), read$()) in self.val_int
}
</code></pre>
<p>Since the snapshot types of primitive types correspond directly to Viper types, they can also be inlined:</p>
<pre><code class="language-viper">// SomeStruct as above

function snap$SomeStruct(self: Ref): Snap$SomeStruct
  requires acc(SomeStruct(self, read$()))
{
  unfolding acc(SomeStruct(self, read$())) in
    unfolding acc(i32(self.SomeStruct_a), read$()) in
    unfolding acc(i32(self.SomeStruct_b), read$()) in
      cons$SomeStruct(self.SomeStruct_a.val_int, self.SomeStruct_b.val_int)
}
</code></pre>
<h2 id="nested-structures"><a class="header" href="#nested-structures">Nested structures</a></h2>
<p>Nested Rust structures are encoded as in the previous example - the main difference is that every reference to another structure needs to be replaced with the corresponding snapshot type in every constructor.</p>
<p>For instance, assume we extend the previous example with another structure that re-uses <code>SomeStruct</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// assuming SomeStruct as before
struct BiggerStruct {
  foo: i32,
  bar: SomeStruct,
}
<span class="boring">}</span></code></pre></pre>
<p>In this case, Prusti generates another domain type for <code>BiggerStruct</code> whose constructor takes a snapshot type for every instance of <code>SomeStruct</code>; analogously, its snapshot function invokes <code>snap$SomeStruct</code> to convert references to <code>SomeStruct</code> into deep values of type <code>Snap$SomeStruct</code>: </p>
<pre><code class="language-viper">domain Snap$BiggerStruct {
  function cons$BiggerStruct(foo: Int, bar: Snap$SomeStruct): Snap$BiggerStruct

  // axioms ...
}

function snap$BiggerStruct(self: Ref): Snap$BiggerStruct
  requires acc(BiggerStruct(self, read$()))
{
  unfolding acc(BiggerStruct(self, read$())) in
    cons$BiggerStruct(snap$i32(self.BiggerStruct_foo), snap$SomeStruct(self.BiggerStruct_bar))
}
</code></pre>
<h2 id="enumerations-1"><a class="header" href="#enumerations-1">Enumerations</a></h2>
<blockquote>
<p><strong>This feature is not fully implemented in Prusti yet.</strong></p>
</blockquote>
<p>While the snapshot-based encoding of enumerations is mostly analogous to the encoding of structs, it needs to account for multiple enum <em>variants</em>, which are distinguished by an integer-valued discriminant. Consequently, the snapshot domain generated for an enumeration is slightly more involved:</p>
<ul>
<li>It contains one constructor for each variant of the enumeration.</li>
<li>It contains one injectivity axiom for each variant.</li>
<li>It additionally needs to ensure that different constructors yield different snapshot values. To this end, we introduce a new domain function mapping every snapshot value to its enumeration discriminant - an integer representing the variant. Moreover, for each variant, we add an axiom expressing that constructors yield snapshot values with the correct discriminant.</li>
<li>Its heap-dependent <code>snap$</code> function needs to branch over the enumeration's <code>discriminant</code> field to select the correct constructor when converting a reference to a snapshot value.</li>
</ul>
<p>For example, consider the enumeration below, which defines a custom Option type.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// assuming SomeStruct as before
enum MyOption {
  _Some(SomeStruct),
  _None,
}
<span class="boring">}</span></code></pre></pre>
<p>The corresponding snapshot encoding is defined as follows:</p>
<pre><code class="language-viper">domain Snap$MyOption {
  // one constructor for each variant
  function cons$MyOption$0(): Snap$MyOption
  function cons$MyOption$1(x: Snap$SomeStruct): Snap$MyOption

  // injectivity axioms for all constructors with parameters
  axiom Snap$MyOption$injectivity$1 {
    forall
      i: Snap$SomeStruct, j: Snap$SomeStruct :: { cons$MyOption$1(i), cons$MyOption$1(j) }
      cons$MyOption$1(i) == cons$MyOption$1(j) ==&gt; i == j
  }

  // map snapshot values to variant discriminant
  function discriminant$MyOption(x: Snap$MyOption): Int

  // axiom defining possible discriminant values 
  axiom Snap$MyOption$discriminants {
    forall
      x: Snap$MyOption :: 
      discriminant$MyOption(x) == 0 || discriminant$MyOption(x) == 1
  }

  // one axiom characterizing the discriminant for each constructor
  axiom Snap$MyOption$0 {
    discriminant$MyOption(cons$MyOption$0()) == 0
  }
  
  axiom Snap$MyOption$1 {
    forall
      i: Snap$SomeStruct :: { cons$MyOption$1(i) } 
      discriminant$MyOption(cons$MyOption$1(i)) == 1
  }
}

// heap-dependent function for computing snapshot values
function snap$MyOption(x: Ref): Snap$MyOption
  requires acc(MyOption(x), read$())
{
  // call the cons function matching the discriminant
  unfolding acc(MyOption(x), read$()) in 
    x.discriminant == 1
      ? unfolding acc(MyOption$_Some(x.enum_val), read$()) in
          cons$MyOption$1(snap$SomeStruct(x.enum_val))
      : cons$MyOption$0()
}
</code></pre>
<h2 id="applications-of-snapshots"><a class="header" href="#applications-of-snapshots">Applications of snapshots</a></h2>
<p>Prusti makes use of the heap-independent encoding of types via snapshots 
to implement several features, which are collected below.</p>
<h3 id="structural-equality"><a class="header" href="#structural-equality">Structural equality</a></h3>
<p>Prusti uses the snapshot-based encoding for checking whether two instances of a data structure are equal. That is, both <code>x == y</code> and <code>std::cmp::eq(x,y)</code> are encoded as a comparison of the snapshot values of <code>x</code> and <code>y</code>:</p>
<pre><code class="language-viper">snap$Type(x) == snap$Type(y)
</code></pre>
<p>Inequalities <code>x != y</code> are encoded analogously. </p>
<p>Notice that Prusti only uses snapshots for a subset of <em>supported</em> types. More precisely, a type <code>T</code> has to meet the following conditions:</p>
<ol>
<li><code>T</code> automatically derives the trait <a href="https://doc.rust-lang.org/std/cmp/trait.Eq.html"><code>Eq</code></a>.</li>
<li><code>T</code> is composed of other supported types, i.e., primitive types and other types that derive <code>Eq</code>.</li>
</ol>
<p>If a type does not meet these criteria, it either invokes a user-supplied custom implementation or a bodyless stub function.</p>
<h3 id="comparing-return-values-of-pure-functions"><a class="header" href="#comparing-return-values-of-pure-functions">Comparing return values of pure functions</a></h3>
<p>Whenever one invokes a <a href="encoding/pure.html">pure function</a> with equal arguments, the function should yield the same return value, i.e., a function <code>f</code> with one argument should satisfy the following specification:</p>
<pre><code>x == y  ==&gt; f(x) == f(y)
</code></pre>
<p>For non-recursive types, the snapshot function <code>snap$type(ref)</code> recursively unfolds the predicate encoding the type of <code>ref</code>. Hence, the above property holds whenever equality of the type of <code>x</code> and <code>y</code> corresponds to structural equality, i.e., whenever the <code>Eq</code> trait is automatically derived. </p>
<p>For example, the following piece of Rust code verifies while internally using snapshots to discharge equality checks:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// as before, but derives Eq
#[derive(PartialEq, Eq)]
struct SomeStruct {
  a: i32,
  b: i32,
}

#[pure]
#[requires(x == y)]
#[ensures(result == y.a)]
fn foo(x: SomeStruct, y: SomeStruct) -&gt; i32 {
  x.a
}

#[requires(x == y)]
#[ensures(result == 2 * foo(x))]
fn test(x: SomeStruct, y: SomeStruct) -&gt; i32 {
    foo(x) + foo(y)
}
<span class="boring">}</span></code></pre></pre>
<p>However, the snapshot function cannot completely unfold potentially unbounded recursive types.
To enable the same behavior as specified above, Prusti thus introduces a shortcut that enables lazy evaluation of snapshot functions: For each pure function <code>f</code> that takes a recursive type (that also derives <code>Eq</code>) as an argument, it generates a domain function <code>mirror$f</code> - called the <em>mirror function</em> - that takes snapshots instead of references as arguments.
In the postcondition of <code>f</code>, Prusti then links the return values of <code>f</code> to the return value of <code>mirror$f</code>: Both functions are required to yield the same return value whenever <code>mirror$f</code> is invoked on the snapshot of <code>f</code>'s argument. 
The code snippet below outlines this encoding.</p>
<pre><code class="language-viper">domain Mirrors {
  function mirror$f(x: Snap$SomeRecStruct) : Int
}

function f(x:Ref) : Int
  requires SomeRecStruct(x)
  ensures [result == mirror$f(snap$SomeRecStruct(x)), true]
{
  // ... 
}
</code></pre>
<h3 id="pure-functions-returning-copy-types"><a class="header" href="#pure-functions-returning-copy-types">Pure functions returning copy types</a></h3>
<p>Prusti uses snapshots to encode <a href="encoding/pure.html">pure Rust functions</a> that return structures or enumerations.
This is necessary because Viper does not allow resource assertions within the postcondition of functions.
At the moment, only types implementing the <a href="https://doc.rust-lang.org/core/marker/trait.Copy.html"><code>Copy</code></a> trait are supported.</p>
<p>As an example, assume both the struct <code>BiggerStruct</code> and the struct <code>SomeStruct</code> from previous examples derive the traits <code>Copy</code> and <code>Eq</code>.
Moreover, consider the following pure function <code>get</code> mapping every instance of <code>BiggerStruct</code> to its wrapped instance of <code>SomeStruct</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[pure]
fn get(x: BiggerStruct) -&gt; SomeStruct {
  x.bar
}
<span class="boring">}</span></code></pre></pre>
<p>Prusti encodes the function <code>get</code> as a Viper function that first computes the result of <code>get</code> and then invokes the snapshot function <code>snap$SomeStruct</code> to return a snapshot value instead of a reference:</p>
<pre><code class="language-viper">// snapshot domains are encoded as in previous examples
function get(x: Ref): Snap$SomeStruct
  requires BiggerStruct(x)
{
  unfolding BiggerStruct(x) in snap$SomeStruct(x.bar)
}
</code></pre>
<p>At the call site, the returned snapshot value is transformed into the default heap-based encoding by first havocking the involved reference and then assuming that the reference's snapshot coincides with the returned snapshot value:</p>
<pre><code class="language-viper">// encoding of x = get(y)
var x: Ref 
x := builtin$havoc_ref()
inhale acc(SomeStruct(x), write) &amp;&amp; snap$SomeStruct(x) == get(y)
</code></pre>
<blockquote>
<p><strong>Warning:</strong> Pure functions returning non-primitive types are partially supported by Prusti.
In particular, chaining pure functions, e.g., <code>f(g(h(x, y)))</code>, and constructing new
instances of Copy types within pure functions is currently not fully supported.</p>
</blockquote>
<h3 id="quantification-over-structures"><a class="header" href="#quantification-over-structures">Quantification over structures</a></h3>
<blockquote>
<p><strong>TODO</strong>: Has this been added in the context of closures?</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pure-function-encoding"><a class="header" href="#pure-function-encoding">Pure function encoding</a></h1>
<p>To encode specifications and side-effect-free functions (marked with <code>#[pure]</code>), Prusti generates Viper <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#functions">functions</a>. A Viper function consists of a single expression, so Rust function bodies must be folded accordingly. This is only possible for loop-less functions.</p>
<p>For example, the Rust function:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[pure]
fn hello(a: i32) -&gt; i32 {
  let mut b = 10;
  if a &lt; 3 {
    b = a + 2
  } else if a &gt; 10 {
    b = a - 2
  }
  b
}
<span class="boring">}</span></code></pre></pre>
<p>Is encoded as:</p>
<pre><code class="language-viper">function hello(a: Int): Int
  requires true
{
  !(a &lt; 3) ? (!(a &gt; 10) ? 10 : a - 2) : a + 2
}
</code></pre>
<blockquote>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/6e5d9e258c5d674bc0cd2f3d42c061ddf6409b1a/prusti-viper/src/encoder/mir_interpreter.rs#L35-L93"><code>prusti-viper/src/encoder/mir_interpreter.rs</code> - <code>run_backward_interpretation</code></a> - backward state interpreter, used to determine if MIR has any loops.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/6e5d9e258c5d674bc0cd2f3d42c061ddf6409b1a/prusti-viper/src/encoder/pure_function_encoder.rs"><code>prusti-viper/src/encoder/pure_function_encoder.rs</code></a></li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="name-mangling"><a class="header" href="#name-mangling">Name mangling</a></h1>
<p>To ensure there are no duplicate names in the generated Viper code, name mangling is employed. Name mangling can be disabled with the <a href="encoding/../config/flags.html#disable_name_mangling"><code>DISABLE_NAME_MANGLING</code></a> flag, although this may result in errors due to name collisions.</p>
<p>For example, to encode the type <a href="https://doc.rust-lang.org/std/ops/struct.Range.html">std::ops::Range</a>, rather than generating the predicate:</p>
<pre><code class="language-viper">predicate Range(self) {
  ...
}
</code></pre>
<p>Prusti generates:</p>
<pre><code class="language-viper">predicate m_core$$ops$opensqu$0$closesqu$$$range$opensqu$0$closesqu$$$Range$opensqu$0$closesqu$$_beg_$i32$_end_(self) {
  ...
}
</code></pre>
<p>This is the encoded form of <code>m_core::ops[0]::range[0]::Range[0]$_beg_$i32$_end_</code>.</p>
<h2 id="mangling-rules"><a class="header" href="#mangling-rules">Mangling rules</a></h2>
<p>The following replacements are performed during name mangling:</p>
<div class="table-wrapper"><table><thead><tr><th>Original characters</th><th>Replacement</th></tr></thead><tbody>
<tr><td><code>::</code></td><td><code>$$</code></td></tr>
<tr><td><code>&lt;</code></td><td><code>$openang$</code></td></tr>
<tr><td><code>&gt;</code></td><td><code>$closeang$</code></td></tr>
<tr><td><code>(</code></td><td><code>$openrou$</code></td></tr>
<tr><td><code>)</code></td><td><code>$closerou$</code></td></tr>
<tr><td><code>[</code></td><td><code>$opensqu$</code></td></tr>
<tr><td><code>]</code></td><td><code>$closesqu$</code></td></tr>
<tr><td><code>{</code></td><td><code>$opencur$</code></td></tr>
<tr><td><code>}</code></td><td><code>$closecur$</code></td></tr>
<tr><td><code>,</code></td><td><code>$comma$</code></td></tr>
<tr><td><code>;</code></td><td><code>$semic$</code></td></tr>
<tr><td><code> </code></td><td><code>$space$</code></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="repository-layout"><a class="header" href="#repository-layout">Repository Layout</a></h1>
<p>This section describes the crates located in the Prusti repository, their function, and key modules. Some important files are linked and described individually, although this list is far from complete.</p>
<h2 id="binaries"><a class="header" href="#binaries">Binaries</a></h2>
<p>These crates relate to the runnable executables produced during compilation.</p>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti"><code>prusti/</code></a>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti/src/bin/prusti-driver.rs"><code>src/bin/prusti-driver.rs</code></a> - invokes the Rust compiler with Prusti callbacks set up.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti/src/bin/prusti-rustc.rs"><code>src/bin/prusti-rustc.rs</code></a> - spawns <code>prusti-driver</code> with the correct environment.</li>
</ul>
</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-launch"><code>prusti-launch/</code></a> - utilities for Prusti binaries.</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-server"><code>prusti-server/</code></a> - <a href="pipeline/viper.html#prusti-server">Prusti compilation server</a>.</li>
</ul>
<h2 id="specification-parsing"><a class="header" href="#specification-parsing">Specification parsing</a></h2>
<p>These crates relate to parsing Prusti-specific specifications in Rust code (e.g. <code>requires</code>, <code>ensures</code>, etc). These specifications are defined using <a href="https://doc.rust-lang.org/reference/procedural-macros.html">procedural macros</a>, which must be contained in their own crates, hence the additional <code>prusti-contracts/*</code> crates.</p>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/master/prusti-contracts/prusti-contracts"><code>prusti-contracts/prusti-contracts/</code></a> - stubs for Rust pseudo-functions used in specifications; currently <code>old</code> and <code>before_expiry</code>. It also reexports the procedural macros <code>requires</code>, <code>ensures</code>, etc. Depending on the <code>prusti</code> feature, it exports either <code>impl</code> or <code>internal</code>.</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/master/prusti-contracts/prusti-contracts-proc-macros"><code>prusti-contracts/prusti-contracts-proc-macros/</code></a> – a procedural macro crate that either forwards calls to <code>prusti-specs</code> (if the <code>prusti</code> feature is enabled) or tries to be invisible when compiling with the regular compiler (if the <code>prusti</code> feature is disabled). The <code>prusti</code> feature is set automatically when compiling with Prusti.</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/master/prusti-contracts/prusti-specs"><code>prusti-contracts/prusti-specs/</code></a> - does the specification rewriting.</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/master/prusti-contracts/prusti-contracts-test"><code>prusti-contracts/prusti-contracts-test</code></a> – a minimal test that checks that <code>prusti-contracts</code> can be used with a regular compiler.</li>
</ul>
<h2 id="common-library-code"><a class="header" href="#common-library-code">Common library code</a></h2>
<p>These crates contain the majority of Prusti's code.</p>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common"><code>prusti-common/</code></a> - common modules used across Prusti (code independent from Rust internals).
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir"><code>src/vir/</code></a> - VIR.
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/ast"><code>ast/</code></a> - Viper IR enum definitions and methods to generate Viper code (as text).</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/optimizations"><code>optimizations/</code></a> - optimizations of Viper IR.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/borrows.rs"><code>borrows.rs</code></a> - reborrowing DAG definition.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/conversions.rs"><code>conversions.rs</code></a> - implicit casts from Rust types to Viper IR.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/program.rs"><code>program.rs</code></a> - struct holding a full Viper program.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/to_viper.rs"><code>to_viper.rs</code></a> - conversion of <code>vir</code> module structs to Viper AST.</li>
<li><a href="https://github.com/viperproject/prusti-dev/blob/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-common/src/vir/utils.rs"><code>utils.rs</code></a> - functional operations on VIR.</li>
</ul>
</li>
<li>(+ other utility code)</li>
</ul>
</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-interface"><code>prusti-interface/</code></a> - wrapper around the Rust compiler internals that aims to provide a more stable interface (however, it fails to <strong>completely</strong> encapsulate the Rust compiler from its clients).
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-interface/src/environment"><code>src/environment/</code></a> - most of the wrapper code lives here.</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-interface/src/specs"><code>src/specs/</code></a> – collect type-checked specifications.</li>
</ul>
</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/prusti-viper"><code>prusti-viper/</code></a> - MIR to VIR encoding.</li>
</ul>
<h2 id="jvm-bindings"><a class="header" href="#jvm-bindings">JVM bindings</a></h2>
<ul>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/viper-sys"><code>viper-sys</code></a> – low-level (unsafe) JVM bindings.</li>
<li><a href="https://github.com/viperproject/prusti-dev/tree/9ca9cd1b9bcfd9870691fa5a7a957a90987ba4af/viper"><code>viper</code></a> – higher-level JVM bindings.</li>
</ul>
<h2 id="deprecated-or-removed"><a class="header" href="#deprecated-or-removed">Deprecated or removed</a></h2>
<ul>
<li><code>prusti-filter/</code> - walks through Rust crates to check which are supported by Prusti (used for evaluation in Prusti publication).</li>
<li><code>prusti-macros/</code> - macros to simplify parsing code.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development"><a class="header" href="#development">Development</a></h1>
<ul>
<li><a href="development/setup.html">Setup</a></li>
<li><a href="development/build.html">Building</a></li>
<li><a href="development/tests.html">Tests</a></li>
<li><a href="development/ide.html">IDE integration</a></li>
<li><a href="development/debug.html">Debugging</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<p>This section details the setup required before Prusti can be built from source.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li><a href="https://rustup.rs/"><code>rustup</code></a></li>
<li><a href="https://www.python.org/downloads/">Python 3</a> (for <a href="development/setup.html#xpy"><code>x.py</code></a>)</li>
</ul>
<h2 id="xpy"><a class="header" href="#xpy"><code>x.py</code></a></h2>
<p><code>x.py</code> is a Python script that provides a convenient wrapper for a Prusti development setup. It can be initialized by running:</p>
<pre><code class="language-bash">$ ./x.py setup
</code></pre>
<p>The script will perform the following steps:</p>
<ol>
<li>(Ubuntu only) Installs the <a href="development/setup.html#native-dependencies">native dependencies</a> (except for java).
<ul>
<li>On other OS (including non-Ubuntu Linux distributions) this step has to be performed manually.</li>
</ul>
</li>
<li>Downloads and extracts the latest <a href="development/setup.html#viper-tools">Viper tools</a>.</li>
<li>Sets up <a href="development/setup.html#rustup-setup">the Rust toolchain</a>.</li>
</ol>
<p>Step 1 can be skipped by adding the <code>--no-deps</code> argument to the command line. <code>--dry-run</code> can be used to prevent any shell commands from actually running, only printing them to the terminal.</p>
<p>The <code>setup</code> step should be repeated if the Rust toolchain version changes, or if the native dependencies or Viper tools need to be updated.</p>
<h2 id="native-dependencies"><a class="header" href="#native-dependencies">Native dependencies</a></h2>
<h3 id="linux"><a class="header" href="#linux">Linux</a></h3>
<p>On a Linux-based OS, the required libraries are:</p>
<ul>
<li><code>build-essential</code></li>
<li><code>pkg-config</code></li>
<li><code>curl</code></li>
<li><code>gcc</code></li>
<li><code>libssl-dev</code></li>
<li><code>openjdk-11-jdk</code> (or newer)</li>
</ul>
<h3 id="macos"><a class="header" href="#macos">macOS</a></h3>
<p>On macOS, <a href="https://www.oracle.com/java/technologies/javase-downloads.html">Java JDK 11</a> or newer is required.</p>
<h2 id="viper-tools"><a class="header" href="#viper-tools">Viper tools</a></h2>
<p><a href="http://viper.ethz.ch/downloads/">Viper tools</a> are required by Prusti. Extracting the appropriate version into a directory called <code>viper_tools</code> in the project root allows <code>x.py</code> to automatically locate the Viper libraries and the Z3 solver.</p>
<h2 id="rustup-setup"><a class="header" href="#rustup-setup"><code>rustup</code> setup</a></h2>
<p>Rust versions and components are managed with <code>rustup</code>. The toolchain version in use is listed in the <a href="https://github.com/viperproject/prusti-dev/blob/master/rust-toolchain"><code>rust-toolchain</code></a> file. Additional components used are:</p>
<ul>
<li><code>rust-src</code></li>
<li><code>rustc-dev</code></li>
<li><code>llvm-tools-preview</code></li>
<li><code>rustfmt</code> (optional)</li>
</ul>
<h2 id="using-locally-built-version-in-prusti-assistant"><a class="header" href="#using-locally-built-version-in-prusti-assistant">Using locally built version in Prusti Assistant</a></h2>
<p><strong>Note:</strong> These instructions were tested only on Ubuntu.</p>
<p>To use the locally compiled version in Prusti Assistant, make sure to build Prusti in release mode:</p>
<pre><code class="language-bash">./x.py build --release
</code></pre>
<p>Prepare a Prusti package in a new folder:</p>
<pre><code class="language-bash">./x.py package release &lt;prusti-package-path&gt;
</code></pre>
<p>Open VS Code and change its settings as follows:</p>
<ul>
<li>Set <code>prusti-assistant.buildChannel</code> to <code>Local</code>.</li>
<li>Set <code>prusti-assistant.localPrustiPath</code> to the <code>&lt;prusti-package-path&gt;</code> that you chose.</li>
</ul>
<p>Now, you should be able to verify Rust programs with a locally built version of Prusti.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building"><a class="header" href="#building">Building</a></h1>
<p>Once the <a href="development/setup.html">development setup</a> is complete, Prusti can be compiled. Using the Python wrapper script:</p>
<pre><code>$ ./x.py build
</code></pre>
<p>The script will set the following environment variables if they are not already set, before running <code>cargo build</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Default value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>JAVA_HOME</code></td><td>Detected based on OS.</td><td>Java JDK location.</td></tr>
<tr><td><code>RUST_TEST_THREADS</code></td><td><code>1</code></td><td>Limits the number of threads used for running tests.</td></tr>
<tr><td><code>LD_LIBRARY_PATH</code> (and <code>DYLD_LIBRARY_PATH</code> on macOS)</td><td>Detected inside <code>JAVA_HOME</code></td><td>Path containing <code>libjvm.so</code> (<code>libjvm.dylib</code> on macOS).</td></tr>
<tr><td><code>VIPER_HOME</code></td><td><code>viper_tools/backends</code></td><td>Path containing <code>silicon.jar</code>, <code>carbon.jar</code>, and various supporting Java libraries.</td></tr>
<tr><td><code>Z3_EXE</code></td><td><code>(VIPER_HOME)/../z3/bin/z3</code></td><td>Path to the <code>z3</code> solver executable.</td></tr>
</tbody></table>
</div>
<p>Any additional arguments are added to the <code>cargo build</code> command line. For example:</p>
<pre><code class="language-bash">$ ./x.py build --all --verbose
</code></pre>
<h2 id="verbose-mode"><a class="header" href="#verbose-mode">Verbose mode</a></h2>
<p>To see which environment variables <code>./x.py</code> is setting, the <code>++verbose</code> flag can be passed on the command line before the <code>cargo</code> command:</p>
<pre><code class="language-bash">./x.py ++verbose build
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tests"><a class="header" href="#tests">Tests</a></h1>
<p>Tests for the Prusti project can be executed using the Python wrapper script:</p>
<pre><code class="language-bash">./x.py test
</code></pre>
<p>The script sets up environment variables just like in the <a href="development/build.html">build</a> phase, then runs <code>cargo test</code>.</p>
<p>Any additional arguments are added to the <code>cargo test</code> command line. For example:</p>
<pre><code class="language-bash">$ ./x.py test --all --verbose
</code></pre>
<h2 id="filtering-tests"><a class="header" href="#filtering-tests">Filtering tests</a></h2>
<p>The <a href="https://doc.rust-lang.org/book/ch11-02-running-tests.html">options available</a> when running <code>cargo test</code> still apply. For example, to only run tests which contain <code>mod</code> in their name:</p>
<pre><code class="language-bash">$ ./x.py test mod
</code></pre>
<h2 id="additional-flags"><a class="header" href="#additional-flags">Additional flags</a></h2>
<p>Some tests require setting additional flags, for example, to ensure that the number of quantifier instantiations is below a certain bound. This can be achieved by adding at the top of the test file <code>// compile-flags:</code> followed by the <a href="development/../config/flags.html">list of arguments</a> to Prusti. For example, the following comment would bound the number of unique triggers used to instantiate a quantifier to 20:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// compile-flags: -Psmt_unique_triggers_bound=20
<span class="boring">}</span></code></pre></pre>
<h2 id="debugging-tests"><a class="header" href="#debugging-tests">Debugging tests</a></h2>
<p>See <a href="development/../development/debug.html">the debugging section</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ide-integration"><a class="header" href="#ide-integration">IDE integration</a></h1>
<h2 id="warnings-as-errors"><a class="header" href="#warnings-as-errors">Warnings as Errors</a></h2>
<p>Prusti uses rather strict code style settings, producing errors for unnecessary code like unused imports. Although this is useful (especially since incremental builds can hide warnings that still apply), it is often obstructive while  actively working on the codebase. These linter errors can be treated as  warnings instead of errors by providing a compiler flag:</p>
<ul>
<li>With a command-line argument to Rust: <code>--cap-lints warn</code></li>
<li>With an environment variable: <code>RUSTFLAGS='--cap-lints warn'</code></li>
</ul>
<h2 id="vs-code"><a class="header" href="#vs-code">VS Code</a></h2>
<p>Assuming VS Code is in <code>PATH</code>, it can be launched directly with the correct environment variables set up using <code>x.py</code>:</p>
<pre><code class="language-bash">$ ./x.py ide
</code></pre>
<p>Any additional arguments are passed to VS Code.</p>
<h2 id="intellij-rust"><a class="header" href="#intellij-rust">IntelliJ Rust</a></h2>
<p>When using the <a href="https://intellij-rust.github.io/">Rust Plugin for IntelliJ</a>, a lot of spurious errors may be found in the code. This is because Prusti uses a custom toolchain (set in the <code>rust-toolchain</code> file), which makes the plugin fail to load the <a href="https://doc.rust-lang.org/std/prelude/">prelude definitions</a>. The issue is tracked in the <code>intellij-rust</code> repository <a href="https://github.com/intellij-rust/intellij-rust/issues/4930">here</a>.</p>
<p>A temporary workaround is to set the path to the toolchain in use in IntelliJ settings.</p>
<ul>
<li>Inside the Prusti directory, run <code>rustup which cargo</code> in the terminal.</li>
<li>Go to Preferences &gt; Languages &amp; Frameworks &gt; Rust.</li>
<li>Change the standard library location to the standard library directory inside the Rust toolchain.</li>
</ul>
<p>As an example, if <code>rustup which cargo</code> returned <code>/Users/example/.rustup/toolchains/nightly-2020-08-17-x86_64-apple-darwin/bin/cargo</code>, the standard library directory is <code>/Users/example/.rustup/toolchains/nightly-2020-08-17-x86_64-apple-darwin/lib/rustlib/src/rust/library</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging"><a class="header" href="#debugging">Debugging</a></h1>
<p>The <code>x.py</code> script can be used to run Prusti on an individual file:</p>
<pre><code class="language-bash">$ ./x.py run --bin prusti-rustc path/to/the/file.rs
</code></pre>
<p>See the list of <a href="development/../config/flags.html">flags</a> for way to configure Prusti. Of particular use when debugging are:</p>
<ul>
<li><a href="development/../config/flags.html#print_desugared_specs"><code>PRINT_DESUGARED_SPECS</code></a></li>
<li><a href="development/../config/flags.html#dump_viper_program"><code>PRUSTI_DUMP_VIPER_PROGRAM</code></a></li>
<li><a href="development/../config/flags.html#log"><code>PRUSTI_LOG</code></a></li>
</ul>
<h2 id="debugging-tests-1"><a class="header" href="#debugging-tests-1">Debugging tests</a></h2>
<p>A proposed way of fixing Prusti limitations is to add a regression test by creating a new file in <code>prusti-tests/tests</code> and then use the following command to get Prusti output:</p>
<pre><code class="language-bash">./x.py build --all &amp;&amp; \
RUST_BACKTRACE=1 PRUSTI_DUMP_VIPER_PROGRAM=true PRUSTI_DUMP_DEBUG_INFO=true \
./x.py ++verbose verify-test &lt;path-to-the-test-file&gt;
</code></pre>
<p>This command does the following:</p>
<ol>
<li>Ensures that Prusti is compiled.</li>
<li>Runs the specified test taking into account the configuration flags specified in the test file.</li>
<li>Dumps the information that is most commonly needed for debugging Prusti into the <code>log</code> directory.</li>
</ol>
<p>Tip: to see the expanded Prusti specification macros, add the following comment at the beginning of the test file:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// compile-flags: -Zunpretty=expanded
<span class="boring">}</span></code></pre></pre>
<h3 id="running-prusti-in-a-debugger"><a class="header" href="#running-prusti-in-a-debugger">Running Prusti in a debugger</a></h3>
<p>The <code>verify-test</code> command also generates a VS Code launch config, which allows you to run Prusti in a debugger.</p>
<ul>
<li>In the <code>Cargo.toml</code>, section <code>[profile.dev]</code>, set <code>debug = 2</code>. This enables debug symbols.</li>
<li>Install the CodeLLDB VS Code extension.</li>
</ul>
<p>Now you can set breakpoints and launch the debugger.</p>
<h3 id="debugging-performance-problems"><a class="header" href="#debugging-performance-problems">Debugging performance problems</a></h3>
<p>In case you are debugging a performance problem and suspect that it is caused by quantifiers, append <code>--analyze-quantifiers</code> to the command after the <code>&lt;path-to-the-test-file&gt;</code>. This will run Z3 in tracing mode and produce CSV files with various statistics in <code>log/smt</code> directory. In case you want to see all terms that were used to trigger a specific quantifier, you can produce the list of them with the following command:</p>
<pre><code class="language-bash">PRUSTI_SMT_TRACE_QUANTIFIER_TRIGGERS=&lt;quantifier-id&gt; \
./x.py ++verbose run --release --bin smt-log-analyzer log/smt/&lt;function&gt;/trace1.log
</code></pre>
<p>You can find the list of quantifier ids and names in <code>log/smt/&lt;function&gt;/trace1.log.unique-triggers.csv</code>. Running the <code>smt-log-analyzer</code> will generate <code>log/smt/&lt;function&gt;/trace1.log.quantifier-&lt;quantifier-id&gt;-triggers.csv</code> file containing all triggers used to instantiate the quantifier.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
